<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Update</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f6f8fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #24292f;
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 10px;
        }
        .issue-item {
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #f6f8fa;
        }
        .issue-item.removing {
            opacity: 0;
            transform: translateY(-20px) scale(0.98);
            transition: opacity 0.4s cubic-bezier(.4,0,.2,1), transform 0.4s cubic-bezier(.4,0,.2,1);
            pointer-events: none;
        }
        .issue-title {
            font-weight: 600;
            color: #0969da;
            margin-bottom: 8px;
        }
        .issue-meta {
            font-size: 14px;
            color: #656d76;
            margin-bottom: 12px;
        }
        .status-options {
            margin: 12px 0;
        }
        .status-options label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        .status-options input[type="radio"] {
            margin-right: 8px;
        }
        .comment-box {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
        }
        .submit-btn {
            background-color: #1f883d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }
        .submit-btn:hover {
            background-color: #1a7f37;
        }
        .loading {
            text-align: center;
            color: #656d76;
            font-style: italic;
        }
        .error {
            color: #d1242f;
            background-color: #fff8f8;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
        }
        .auth-section {
            background-color: #fff8dc;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e1cc8a;
        }
        .auth-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📋 Status Update</h1>
        
        <div class="auth-section">
            <h3>Select a project</h3>         
            <input type="password" id="pat" class="auth-input" placeholder="Copy & paste GitHub Personal Access Token" value="">   
            <select id="owner_repo" class="auth-input", onchange="populateAssignees()">
                <option value="" disabled selected>Select repository owner/organization</option>
                <option value="RTO-Spinal-Stim/Stroke-R01/2">Stroke R01</option>
                <!-- Add more owners/orgs as needed -->
            </select>
            <select id="username" class="auth-input" style="display:none;">
                <option value="" disabled selected>Loading team members...</option>
            </select>            
            <button onclick="loadIssues()" class="submit-btn">Load My Issues</button>
            <p style="font-size: 12px; color: #656d76; margin-top: 8px;">
                <strong>Note:</strong> This uses GitHub's public API. Authentication is required with a Personal Access Tokento update issues in repos where you have write access.
            </p>
        </div>

        <form id="statusForm">
            <div id="issuesContainer">
                <div class="loading">Click "Load My Issues" to fetch your assigned issues...</div>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn" style="display: none;">Submit Status Updates</button>
        </form>
    </div>
    <!-- Add this after your main .container div -->
    <div id="new-issues-sidebar" style="
        position: fixed;
        top: 0;
        right: 0;
        width: 370px;
        height: 100vh;
        background: #fff;
        border-left: 1px solid #d1d9e0;
        box-shadow: -2px 0 8px rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        z-index: 900;
        padding: 0;
    ">
        <div style="flex: 1 1 auto; overflow-y: auto; padding: 24px 20px 16px 20px;">
            <h2 style="margin-top:0;">New Issues</h2>
            <div class="new-issue-panel" style="position:relative; background:#f6f8fa; border-radius:8px; padding:18px 16px 16px 16px; margin-bottom:18px; border:1px solid #e1e4e8;">
                <button type="button" class="close-new-issue-btn" title="Cancel" style="
                    position:absolute;
                    top:10px;
                    right:10px;
                    background:transparent;
                    border:none;
                    color:#d1242f;
                    font-size:22px;
                    font-weight:bold;
                    cursor:pointer;
                    line-height:1;
                ">&times;</button>
                <label style="display:block; margin-bottom:10px;">
                    <strong>Title</strong>
                    <input type="text" class="new-issue-title" style="width:100%; margin-top:4px; padding:7px; border-radius:5px; border:1px solid #d1d9e0; font-size:15px;">
                </label>
                <label style="display:block; margin-bottom:10px;">
                    <strong>Body</strong>
                    <textarea class="new-issue-body" style="width:100%; min-height:70px; margin-top:4px; padding:7px; border-radius:5px; border:1px solid #d1d9e0; font-size:15px; resize:vertical;"></textarea>
                </label>
            </div>
            <!-- Additional new-issue-panel elements will be appended here by JS -->
        </div>
        <div style="padding: 12px 20px 18px 20px; border-top:1px solid #e1e4e8; background:#fafbfc;">
            <button type="button" id="add-new-issue-panel-btn" class="submit-btn" style="background:#0969da; margin-right:10px;">Add Another</button>
            <button type="button" id="submit-new-issues-btn" class="submit-btn" style="background:#1f883d;">Submit</button>
        </div>
    </div>

    <script>
        let currentIssues = [];

        /**
         * Fetches the "Status" project field for a given issue using GitHub's GraphQL API.
         * @param {string} pat - GitHub Personal Access Token
         * @param {string} owner - Repository owner/org
         * @param {string} repo - Repository name
         * @param {number} issueNumber - Issue number
         * @returns {Promise<string|null>} - The status value or null if not found
         */
        async function fetchIssueProjectStatus(pat, owner, repo, issueNumber) {
            const query = `
            query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                issue(number: $issueNumber) {
                    projectItems(first: 10) {
                    nodes {
                        project { title }
                        fieldValues(first: 20) {
                        nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                            field { ... on ProjectV2SingleSelectField { name } }
                            name
                            }
                        }
                        }
                    }
                    }
                }
                }
            }
            `;
            const variables = { owner, repo, issueNumber: Number(issueNumber) };
            const res = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${pat}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query, variables })
            });
            const data = await res.json();
            // Find the "Status" field value
            const items = data.data?.repository?.issue?.projectItems?.nodes || [];
            for (const item of items) {
                for (const fv of item.fieldValues.nodes) {
                    if (fv.field?.name === 'Status') {
                        return fv.name;
                    }
                }
            }
            return null;
        }

        async function loadIssues() {
            const username = document.getElementById('username').value;
            const owner_repo = document.getElementById('owner_repo').value;
            const [owner, repo, project] = owner_repo.split('/');
            const pat = document.getElementById('pat').value;

            if (!username || !repo || !owner) {
                alert('Please fill in all fields');
                return;
            }

            const container = document.getElementById('issuesContainer');
            container.innerHTML = '<div class="loading">Loading your assigned issues...</div>';

            try {
                // Fetch issues assigned to the user
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                if (pat) {
                    headers['Authorization'] = `Bearer ${pat}`;
                }

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues?assignee=${username}&state=open&per_page=100`, {
                    headers
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Repository ${owner}/${repo} not found or not accessible`);
                    } else if (response.status === 403) {
                        throw new Error('API rate limit exceeded or repository is private. Try again later.');
                    } else {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }
                }
                
                const issues = await response.json();
                
                // Filter out pull requests (GitHub API returns both issues and PRs)
                currentIssues = issues.filter(issue => !issue.pull_request);
                if (currentIssues.length === 0) {
                    container.innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                    document.getElementById('submitBtn').style.display = 'none';
                    return;
                }
                renderIssues(currentIssues);
                document.getElementById('submitBtn').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading issues:', error);
                container.innerHTML = `<div class="error">Error loading issues: ${error.message}</div>`;
            }
        }

        function normalizeStatus(status) {
            default_status = 'todo';
            // default_status = 'in_progress';
            if (!status) return default_status;
            switch (status.toLowerCase()) {
                case 'scheduled':
                    return 'scheduled';
                case 'to do':
                case 'todo':
                    return 'todo';
                case 'in progress':
                case 'in_progress':
                    return 'in_progress';
                case 'done':
                case 'completed':
                    return 'completed';
                case 'blocked':
                    return 'blocked';
                case "not doing":
                    return 'not_doing';
                default:
                    return default_status;
            }
        }

        function makeStatusMatchGitHub(status) {
            switch (status.toLowerCase()) {
                case 'todo':
                    return 'Todo';
                case 'in_progress':
                    return 'In Progress';
                case 'completed':
                    return 'Done';
                case 'blocked':
                    return 'Blocked';
                case 'not_doing':
                    return 'Not Doing';
                case 'scheduled':
                    return 'Scheduled';
                default:
                    return status;
            }
        }

        function prettifyStatus(status) {
            switch (status) {
                case 'todo':
                    return '📝 To Do';
                case 'in_progress':
                    return '🔄 In progress';
                case 'completed':
                    return '✅ Done';
                case 'blocked':
                    return '🚫 Blocked';
                case 'not doing':
                    return '❌ Not Doing';
                case 'scheduled':
                    return '📅 Scheduled';
                default:
                    return status;
            }
        }

        async function renderIssues(issues) {
            const container = document.getElementById('issuesContainer');

            if (issues.length === 0) {
                container.innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                document.getElementById('submitBtn').style.display = 'none';
                return;
            }

            // --- Batch GraphQL Query for all issue statuses ---
            const pat = document.getElementById('pat').value;
            const owner_repo = document.getElementById('owner_repo').value;
            const [owner, repo, project] = owner_repo.split('/');

            // Build the batch query
            let batchQuery = 'query BatchStatus {';
            issues.forEach((issue, idx) => {
                batchQuery += `
                    issue${idx}: repository(owner: "${owner}", name: "${repo}") {
                        issue(number: ${issue.number}) {
                            projectItems(first: 10) {
                                nodes {
                                    fieldValues(first: 20) {
                                        nodes {
                                            ... on ProjectV2ItemFieldSingleSelectValue {
                                                field { ... on ProjectV2SingleSelectField { name } }
                                                name
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                `;
            });
            batchQuery += '}';

            // Fetch all statuses in one request
            let statusMap = {};
            try {
                const res = await fetch('https://api.github.com/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: batchQuery })
                });
                const data = await res.json();
                console.log('GraphQL status data:', data);
                if (data.errors) console.error('GraphQL errors:', data.errors);
                issues.forEach((issue, idx) => {
                    const projectItems = data.data?.[`issue${idx}`]?.issue?.projectItems?.nodes || [];
                    let status = null;
                    for (const item of projectItems) {
                        for (const fv of item.fieldValues.nodes) {
                            if (fv.field?.name === 'Status') {
                                status = fv.name;
                            }
                        }
                    }
                    statusMap[issue.number] = status;
                    issue._originalStatus = status; // Store original status for comparison
                });
            } catch (e) {
                // If error, fallback to null statuses
                issues.forEach(issue => statusMap[issue.number] = null);
            }

            // --- Render issues with status as radio selection ---            
            container.innerHTML = issues.map(issue => {
                const status = normalizeStatus(statusMap[issue.number]);
                return `
                    <div class="issue-item" id="issue-item-${issue.number}" style="position:relative;">
                        <button type="button" class="close-issue-btn" data-issue="${issue.number}" title="Remove this issue" style="
                            position:absolute;
                            top:8px;
                            right:8px;
                            background:transparent;
                            border:none;
                            color:#d1242f;
                            font-size:20px;
                            font-weight:bold;
                            cursor:pointer;
                            line-height:1;
                            z-index:2;
                        ">&times;</button>
                        <div class="issue-title">
                            <a href="${issue.html_url}" target="_blank">#${issue.number}: ${issue.title}</a>
                        </div>
                        <div class="issue-meta">
                            ${issue.labels.map(label => `<span style="background: #${label.color || 'e1e4e8'}; color: ${getContrastColor(label.color || 'e1e4e8')}; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 4px;">${label.name}</span>`).join('')}
                            ${issue.milestone ? `• Milestone: ${issue.milestone.title}` : ''}
                            ${issue.created_at ? `• Created: ${new Date(issue.created_at).toLocaleDateString()}` : ''}
                            ${status ? `<div><strong>Current Status: ${prettifyStatus(status)}</strong></div>` : ''}
                        </div>
                        <div class="status-options">
                            <strong>Status Update:</strong>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="scheduled" ${status === 'scheduled' ? 'checked' : ''}>
                                📅 Scheduled
                            </label>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="todo" ${status === 'todo' ? 'checked' : ''}>
                                📝 To Do
                            </label>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="in_progress" ${status === 'in_progress' ? 'checked' : ''}>
                                🔄 In progress
                            </label>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="completed" ${status === 'completed' ? 'checked' : ''}>
                                ✅ Done
                            </label>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="blocked" ${status === 'blocked' ? 'checked' : ''}>
                                🚫 Blocked
                            </label>
                            <label>
                                <input type="radio" name="status_${issue.number}" value="not_doing" ${status === 'not_doing' ? 'checked' : ''}>
                                ❌ Not Doing
                            </label>
                        </div>
                        <textarea 
                            name="comment_${issue.number}" 
                            class="comment-box" 
                            placeholder="Are there any comments or updates about this issue?"></textarea>
                        <button type="button" class="submit-btn single-issue-btn" data-issue="${issue.number}" style="margin-top:10px;">Submit This Issue</button>
                    </div>
                `;
            }).join('');

            // Show the submit button if there are issues
            document.getElementById('submitBtn').style.display = 'block';

            // Attach event listeners for single-issue submit buttons
            document.querySelectorAll('.single-issue-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const issueNumber = this.getAttribute('data-issue');
                    await submitSingleIssue(issueNumber);
                });
            });

            document.querySelectorAll('.close-issue-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const issueNumber = this.getAttribute('data-issue');
                    // Remove from DOM
                    const el = document.getElementById(`issue-item-${issueNumber}`);
                    if (el) {
                        el.classList.add('removing');
                        setTimeout(() => {
                            el.remove();
                            currentIssues = currentIssues.filter(i => i.number != issueNumber);
                            if (currentIssues.length === 0) {
                                document.getElementById('submitBtn').style.display = 'none';
                                document.getElementById('issuesContainer').innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                            }
                        }, 400); // Match the CSS transition duration
                    };
                });
            });
        }

        // Attach event listeners for single-issue submit buttons after rendering
        document.querySelectorAll('.single-issue-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const issueNumber = this.getAttribute('data-issue');
                await submitSingleIssue(issueNumber);
            });
        });
        
        // Helper function to determine text color based on background color
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        // Populate the assignee dropdown based on selected repository
        async function populateAssignees() {
            const ownerRepo = document.getElementById('owner_repo').value;
            const pat = document.getElementById('pat').value;
            const usernameSelect = document.getElementById('username');
            usernameSelect.style.display = 'inline-block';
            usernameSelect.innerHTML = `<option value="" disabled selected>Loading team members...</option>`;

            if (!ownerRepo) {
                usernameSelect.style.display = 'none';
                return;
            }

            const [owner, repo, project] = ownerRepo.split('/');
            const headers = { 'Accept': 'application/vnd.github.v3+json' };
            if (pat) headers['Authorization'] = `Bearer ${pat}`;

            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/collaborators`, { headers });
                if (!res.ok) throw new Error('Could not fetch collaborators');
                const users = await res.json();
                usernameSelect.innerHTML = `<option value="" disabled selected>Select a team member</option>` +
                    users.map(user => `<option value="${user.login}">${user.login}</option>`).join('');
            } catch (e) {
                usernameSelect.innerHTML = `<option value="" disabled selected>Could not load team. Check the GitHub Personal Access Token.</option>`;
            }
        }

        async function submitSingleIssue(issueNumber) {
            const username = document.getElementById('username').value;
            const owner_repo = document.getElementById('owner_repo').value;
            const [owner, repo, project] = owner_repo.split('/');
            const pat = document.getElementById('pat').value;
            const submitBtn = document.querySelector(`.single-issue-btn[data-issue="${issueNumber}"]`);
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const issue = currentIssues.find(i => i.number == issueNumber);
                const status = document.querySelector(`input[name="status_${issue.number}"]:checked`)?.value;
                const comment = document.querySelector(`textarea[name="comment_${issue.number}"]`)?.value;
                const originalStatus = normalizeStatus(issue._originalStatus);

                const update = {
                    issue_number: issue.number,
                    issue_title: issue.title,
                    status: makeStatusMatchGitHub(status),
                    comment: comment || '',
                    user: username,
                    originalStatus: originalStatus
                };

                // Only submit if status changed or comment is non-empty
                const normalizedNew = normalizeStatus(update.status);
                const normalizedOld = normalizeStatus(update.originalStatus);
                if ((normalizedNew === normalizedOld) && (!update.comment || update.comment.trim() === '')) {
                    throw new Error('No changes to submit for this issue.');
                }

                const updateBody = generateUpdateIssue([update], username);
                const updateTitle = `Status Update - ${new Date().toISOString().split('T')[0]} - ${username} - #${issue.number}`;

                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                if (pat) {
                    headers['Authorization'] = `Bearer ${pat}`;
                }

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        title: updateTitle,
                        body: updateBody
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Authentication required. This form cannot create issues in private repositories or when rate limited.');
                    } else if (response.status === 403) {
                        throw new Error('Permission denied. You may not have write access to this repository, or you\'ve hit the API rate limit.');
                    } else if (response.status === 404) {
                        throw new Error('Repository not found or not accessible.');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                    }
                }

                // Remove the issue from the DOM and from currentIssues
                const el = document.getElementById(`issue-item-${issueNumber}`);
                if (el) {
                    el.classList.add('removing');
                    setTimeout(() => {
                        el.remove();
                        currentIssues = currentIssues.filter(i => i.number != issueNumber);
                        if (currentIssues.length === 0) {
                            document.getElementById('submitBtn').style.display = 'none';
                            document.getElementById('issuesContainer').innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                        }
                    }, 400); // Match the CSS transition duration
                }

                // If no issues left, hide the batch submit button and show a message
                if (currentIssues.length === 0) {
                    document.getElementById('submitBtn').style.display = 'none';
                    document.getElementById('issuesContainer').innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                }

            } catch (error) {
                console.error('Error submitting single issue update:', error);
                showErrorMessage(error.message);
            } finally {
                // Only re-enable if the button still exists (not removed)
                if (document.body.contains(submitBtn)) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }
        
        document.getElementById('statusForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const owner_repo = document.getElementById('owner_repo').value;
            const [owner, repo, project] = owner_repo.split('/');
            const pat = document.getElementById('pat').value;
            
            // Disable submit button and show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Collect form data
                console.log('Collecting updates for current issues:', currentIssues);
                const updates = currentIssues.map(issue => {
                    const status = document.querySelector(`input[name="status_${issue.number}"]:checked`)?.value;
                    const comment = document.querySelector(`textarea[name="comment_${issue.number}"]`)?.value;
                    const originalStatus = normalizeStatus(issue._originalStatus);

                    // Log the status element and its value for debugging
                    const statusElement = document.querySelector(`input[name="status_${issue.number}"]:checked`);
                    const statusCheck = statusElement?.value;
                    
                    console.log(`Issue ${issue.number}:`, {
                        statusElement: statusElement,
                        status: statusCheck,
                        allRadios: document.querySelectorAll(`input[name="status_${issue.number}"]`).length
                    });
                    
                    return {
                        issue_number: issue.number,
                        issue_title: issue.title,
                        status: makeStatusMatchGitHub(status),
                        comment: comment || '',
                        user: username,
                        originalStatus: originalStatus
                    };
                })
                // Only include issues where status changed or comment is non-empty
                .filter(update => {
                    // Compare normalized statuses
                    const normalizedNew = normalizeStatus(update.status);
                    const normalizedOld = normalizeStatus(update.originalStatus);
                    return (normalizedNew !== normalizedOld) || (update.comment && update.comment.trim() !== '');
                });

                console.log('Collected updates:', updates);
                if (updates.length === 0) {
                    throw new Error('No issues selected for update.');
                }
                
                // Generate the status update issue body
                const updateBody = generateUpdateIssue(updates, username);
                const updateTitle = `Status Update - ${new Date().toISOString().split('T')[0]} - ${username}`;

                console.log('Generated update body:', updateBody);
                console.log('Update title:', updateTitle);
                
                // Create the status update issue via GitHub API
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                if (pat) {
                    headers['Authorization'] = `Bearer ${pat}`;
                }

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        title: updateTitle,
                        body: updateBody
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Authentication required. This form cannot create issues in private repositories or when rate limited.');
                    } else if (response.status === 403) {
                        throw new Error('Permission denied. You may not have write access to this repository, or you\'ve hit the API rate limit.');
                    } else if (response.status === 404) {
                        throw new Error('Repository not found or not accessible.');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                    }
                }
                
                const createdIssue = await response.json();
                
                // Show success message
                showSuccessMessage(createdIssue, updates.length);
                
            } catch (error) {
                console.error('Error submitting status update:', error);
                showErrorMessage(error.message);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        function generateUpdateIssue(updates, username) {
            const timestamp = new Date().toISOString().split('T')[0];

            let [owner, repo, project] = document.getElementById('owner_repo').value.split('/');
            
            let body = `# Status Update - ${timestamp}\n\n`;
            body += `**Reporter:** @${username}\n\n`;
            body += `**Project:** ${project}\n\n`;
            body += `<!-- STATUS_UPDATE_DATA\n`;
            body += JSON.stringify(updates, null, 2);
            body += `\n-->\n\n`;
            body += `## Summary\n\n`;
            
            updates.forEach(update => {
                
                body += `### Issue #${update.issue_number}: ${update.issue_title}\n`;
                body += `**Status:** ${update.status}\n`;
                if (update.comment) {
                    body += `**Comment:** ${update.comment}\n`;
                }
                body += `\n`;
            });
            
            return body;
        }
        
        function showSuccessMessage(createdIssue, updateCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h2 style="color: #1f883d;">✅ Status Update Submitted Successfully!</h2>
                    <p>Your status update has been submitted and will be processed automatically.</p>
                    
                    <div style="background: #f6f8fa; padding: 16px; border-radius: 6px; margin: 16px 0;">
                        <strong>Created Issue:</strong> <a href="${createdIssue.html_url}" target="_blank">#${createdIssue.number}: ${createdIssue.title}</a><br>
                        <strong>Issues Updated:</strong> ${updateCount}<br>
                        <strong>Status:</strong> The GitHub Action will process this update within a few minutes
                    </div>
                    
                    <p><strong>What happens next:</strong></p>
                    <ul style="text-align: left; margin: 16px 0;">
                        <li>GitHub Actions will automatically process your update</li>
                        <li>Comments will be added to your original issues</li>
                        <li>Issue labels will be updated based on status</li>
                        <li>Completed issues will be closed</li>
                        <li>The status update issue will be closed automatically</li>
                    </ul>
                    
                    <p style="font-size: 14px; color: #656d76;">
                        You can monitor the processing in the <a href="${createdIssue.html_url.replace(/\/issues\/\d+$/, '/actions')}" target="_blank">Actions tab</a> of your repository.
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove(); location.reload();" class="submit-btn">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showErrorMessage(errorMessage) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h2 style="color: #d1242f;">❌ Submission Failed</h2>
                    <p>There was an error submitting your status update:</p>
                    
                    <div style="background: #fff8f8; border: 1px solid #f5c6cb; padding: 16px; border-radius: 6px; margin: 16px 0; color: #721c24;">
                        ${errorMessage}
                    </div>
                    
                    <p><strong>Common solutions:</strong></p>
                    <ul style="text-align: left; margin: 16px 0; font-size: 14px;">
                        <li><strong>Authentication issues:</strong> This form works with public repositories without authentication. For private repos, you'll need to implement token-based authentication.</li>
                        <li><strong>Permission denied:</strong> Make sure you have write access to the repository.</li>
                        <li><strong>Rate limits:</strong> GitHub limits unauthenticated API calls to 60/hour. Wait and try again.</li>
                        <li><strong>Repository not found:</strong> Double-check the owner and repository name.</li>
                    </ul>
                    
                    <button onclick="this.parentElement.parentElement.remove();" class="submit-btn">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ...existing code...

        // --- New Issue Sidebar Logic ---

        (function() {
            const sidebar = document.getElementById('new-issues-sidebar');
            if (!sidebar) return;

            const panelContainer = sidebar.querySelector('div[style*="overflow-y: auto"]');
            const addBtn = document.getElementById('add-new-issue-panel-btn');
            const submitBtn = document.getElementById('submit-new-issues-btn');

            // Helper to create a new issue panel
            function createNewIssuePanel() {
                const panel = document.createElement('div');
                panel.className = 'new-issue-panel';
                panel.style.cssText = "position:relative; background:#f6f8fa; border-radius:8px; padding:18px 16px 16px 16px; margin-bottom:18px; border:1px solid #e1e4e8;";

                panel.innerHTML = `
                    <button type="button" class="close-new-issue-btn" title="Cancel" style="
                        position:absolute;
                        top:10px;
                        right:10px;
                        background:transparent;
                        border:none;
                        color:#d1242f;
                        font-size:22px;
                        font-weight:bold;
                        cursor:pointer;
                        line-height:1;
                    ">&times;</button>
                    <label style="display:block; margin-bottom:10px;">
                        <strong>Title</strong>
                        <input type="text" class="new-issue-title" style="width:100%; margin-top:4px; padding:7px; border-radius:5px; border:1px solid #d1d9e0; font-size:15px;">
                    </label>
                    <label style="display:block; margin-bottom:10px;">
                        <strong>Body</strong>
                        <textarea class="new-issue-body" style="width:100%; min-height:70px; margin-top:4px; padding:7px; border-radius:5px; border:1px solid #d1d9e0; font-size:15px; resize:vertical;"></textarea>
                    </label>
                `;

                // Attach close handler
                panel.querySelector('.close-new-issue-btn').addEventListener('click', function() {
                    panel.remove();
                    // Make sure there's always at least one panel
                    if (panelContainer.querySelectorAll('.new-issue-panel').length === 0) {
                        const newPanel = createNewIssuePanel();
                        panelContainer.appendChild(newPanel);
                    }
                });

                return panel;
            }

            // Add handler for "Add Another"
            addBtn.addEventListener('click', function() {
                const newPanel = createNewIssuePanel();
                panelContainer.appendChild(newPanel);
                // Optionally, scroll to the new panel
                newPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });

            // Attach close handler to the initial panel
            panelContainer.querySelectorAll('.new-issue-panel').forEach(panel => {
                const closeBtn = panel.querySelector('.close-new-issue-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        panel.remove();
                    });
                }
            });

            // Submit handler
            submitBtn.addEventListener('click', async function() {
                const panels = panelContainer.querySelectorAll('.new-issue-panel');
                const newIssues = [];
                panels.forEach(panel => {
                    const title = panel.querySelector('.new-issue-title').value.trim();
                    const body = panel.querySelector('.new-issue-body').value.trim();
                    if (title) {
                        newIssues.push({ title, body });
                    }
                });
                if (newIssues.length === 0) {
                    alert('Please enter at least one issue title.');
                    return;
                }

                // --- Validation for PAT and repo owner/org ---
                const owner_repo = document.getElementById('owner_repo').value;
                const pat = document.getElementById('pat').value;
                const username = document.getElementById('username').value;

                if (!pat) {
                    alert('Please enter your GitHub Personal Access Token (PAT) before submitting.');
                    return;
                }
                if (!owner_repo) {
                    alert('Please select a repository owner/organization before submitting.');
                    return;
                }
                if (newIssues.length === 0) {
                    alert('Please enter at least one issue title.');
                    return;
                }
                if (!username) {
                    alert('Please select a team member before submitting.');
                    return;
                }

                // --- Create a single GitHub issue with formatted text for GitHub Action parsing ---                
                const [owner, repo, projectNumber] = owner_repo.split('/');                

                // Format the body for GitHub Action parsing
                const timestamp = new Date().toISOString().split('T')[0];
                let body = `# New Issue Requests - ${timestamp}\n\n`;
                body += `**Reporter:** @${username}\n\n`;
                body += `**Project:** ${projectNumber}\n\n`;
                body += `<!-- NEW_ISSUE_REQUESTS\n`;
                body += JSON.stringify(newIssues, null, 2);
                body += `\n-->\n\n`;
                body += `## Issues to Create\n\n`;
                newIssues.forEach((issue, idx) => {
                    body += `### ${idx + 1}. ${issue.title}\n`;
                    if (issue.body) {
                        body += `${issue.body}\n`;
                    }
                    body += `\n`;
                });

                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                if (pat) {
                    headers['Authorization'] = `Bearer ${pat}`;
                }

                try {
                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            title: `New Issue Requests - ${timestamp} - ${username}`,
                            body: body
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    // Optionally, clear panels after submit
                    panels.forEach(panel => panel.remove());
                    // Create an empty panel so there's always one available
                    const newPanel = createNewIssuePanel();
                    panelContainer.appendChild(newPanel);

                    // Optionally, show a success message/modal
                    alert('Your new issue requests have been submitted!');

                } catch (error) {
                    alert('Error submitting new issues: ' + error.message);
                }
            });
        })();
        
        // Remove auto-load demo data since we're now using real API
        window.addEventListener('load', function() {
            // Just show the initial loading message
            document.getElementById('issuesContainer').innerHTML = '<div class="loading">Click "Load My Issues" to fetch your assigned issues...</div>';
        });
    </script>
</body>
</html>